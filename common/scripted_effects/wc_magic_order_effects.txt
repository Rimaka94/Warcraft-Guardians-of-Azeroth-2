init_order_spells_effect = {
    add_to_global_variable_list = { name = order_spells target = flag:polymorph }
}

cast_polymorph_effect = {
    if = {
        limit = { exists = var:polymorph_recipient }
        var:polymorph_recipient = {
            save_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:polymorph
            exists = global_var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_scope_as = this_recipient
        }
    }

    scope:this_recipient ?= {
        if = {
            limit = {
                NOT = {
                    has_trait = polymorph
                }
            }

            root = {
                save_temporary_scope_value_as = {
                    name = duration
                    value = wc_spell_polymorph_duration_days_value
                }
            }

            save_scope_value_as = {
                name = spell_dodge_chance
                value = wc_order_magic_resistance_dodge_value
            }

            random_list = {
                80 = {
                    modifier = {
                        is_alive = yes
                        add = 10000
                    }
                    add_trait = polymorph
                    save_scope_value_as = {
                        name = polymorph_prowess
                        value = {
                            value = prowess
                            subtract = 1
                            multiply = -1
                        }
                    }
                    trigger_event = {
                        id = wc_magic_spell_events.1001
                        days = wc_current_spell_duration
                    }
                    hidden_effect = {
                        add_prowess_skill = {
                            value = scope:polymorph_prowess
                        }
                        root = {
                            send_interface_toast = {
                                title = wc_spell_hit
                                left_icon = scope:this_recipient
                                right_icon = root
                                custom_tooltip = wc_polymorph_hit_tt
                            }
                        }
                    }
                }
                20 = {
                    custom_tooltip = wc_polymorph_resist_tt
                    modifier = {
                        is_alive = yes
                        add = scope:spell_dodge_chance
                    }
                    hidden_effect = {
                        root = {
                            send_interface_toast = {
                                title = wc_spell_dodged
                                left_icon = scope:this_recipient
                                right_icon = root
                                custom_tooltip = wc_polymorph_dodge
                            }
                        }
                    }
                }
            }
        }
    }
}